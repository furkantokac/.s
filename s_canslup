#!/usr/bin/env bash
# Usage: ./.canslup [index] [kbps] [tty]
# Example: ./.canslup 0 500 /dev/ttyACM0
# Defaults: index=0, kbps=500, tty=auto (lowest /dev/ttyACM*)

set -e

IDX="${1:-0}"
RATE_KBPS="${2:-500}"
TTY="${3:-}"

IFACE="can${IDX}"

# Find tty if not given
if [ -z "$TTY" ]; then
    ACM_LIST=($(ls /dev/ttyACM* 2>/dev/null || true))
    if [ ${#ACM_LIST[@]} -eq 0 ]; then
        echo "Error: No /dev/ttyACM* device found."
        exit 2
    fi
    # Sort and select the lowest
    TTY=$(printf '%s\n' "${ACM_LIST[@]}" | sort -V | head -n1)
    echo "No TTY specified, using detected device: $TTY"
fi

# Feedback: print parameters
echo "Selected parameters:"
echo "  IFACE:    $IFACE"
echo "  RATE_KBPS:$RATE_KBPS"
echo "  TTY:      $TTY"

# Bitrate mapping for slcand -sX (CiA standard set)
case "${RATE_KBPS}" in
  10)   S_OPT="0" ;; 20)  S_OPT="1" ;; 50)  S_OPT="2" ;;
  100)  S_OPT="3" ;; 125) S_OPT="4" ;; 250) S_OPT="5" ;;
  500)  S_OPT="6" ;; 800) S_OPT="7" ;; 1000) S_OPT="8" ;;
  *)
    echo "Unsupported bitrate ${RATE_KBPS} kbps."
    echo "Supported: 10 20 50 100 125 250 500 800 1000"
    exit 3
    ;;
esac

# If iface exists, warn and exit (user handles cleanup with .canrm)
if ip link show "${IFACE}" >/dev/null 2>&1; then
  echo "Error: ${IFACE} already exists. Use ./.canrm ${IDX} if you want to remove it."
  exit 4
fi

# If an slcand already running on this TTY, stop it (to avoid duplicate daemons)
if pgrep -f "slcand.*${TTY}" >/dev/null 2>&1; then
  echo "Killing existing slcand on ${TTY}..."
  sudo pkill -f "slcand.*${TTY}" || true
fi

echo "Attaching ${TTY} -> ${IFACE} @ ${RATE_KBPS} kbps ..."

sudo slcand -o -c -s${S_OPT} "${TTY}" "${IFACE}"

sudo ip link set up "${IFACE}"

echo "\"${IFACE}\" is up now with ${RATE_KBPS} kbps via ${TTY}."
